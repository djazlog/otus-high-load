# WebSocket Server

## Описание

WebSocket сервер реализован согласно спецификации AsyncAPI в файле `docs/asyncapi.json`. Сервер предоставляет канал `/post/feed/posted` для получения уведомлений о новых постах в реальном времени.

## Архитектура

### Компоненты

1. **WebSocket Hub** (`internal/model/websocket.go`) - управляет всеми WebSocket соединениями
2. **WebSocket Service** (`internal/service/websocket/`) - бизнес-логика для WebSocket операций
3. **WebSocket Handler** (`internal/api/websocket.go`) - HTTP обработчик для WebSocket соединений
4. **Интеграция с Post Service** - автоматическая отправка уведомлений при создании постов

### Схема работы

1. Клиент подключается к WebSocket серверу по адресу `/post/feed/posted`
2. Сервер проверяет JWT токен в заголовке `Authorization: Bearer <token>`
3. При успешной авторизации устанавливается WebSocket соединение
4. При создании нового поста автоматически отправляется уведомление всем подключенным клиентам
5. Клиенты получают сообщения в формате JSON согласно AsyncAPI спецификации

## Использование

### Подключение к WebSocket серверу

```javascript
// JavaScript пример
const token = 'your_jwt_token_here';
const ws = new WebSocket('ws://localhost:8080/post/feed/posted');

// Добавляем заголовок авторизации
ws.onopen = function() {
    // Отправляем токен в заголовке (некоторые WebSocket клиенты поддерживают это)
    // В реальном приложении токен должен передаваться через URL параметры или другие способы
};

ws.onmessage = function(event) {
    const message = JSON.parse(event.data);
    console.log('Received message:', message);
    
    if (message.type === 'post') {
        const post = message.payload;
        console.log('New post:', post.postId, post.postText, post.author_user_id);
    }
};
```

### Формат сообщений

Согласно AsyncAPI спецификации, сообщения имеют следующий формат:

```json
{
  "type": "post",
  "payload": {
    "postId": "1d535fd6-7521-4cb1-aa6d-031be7123c4d",
    "postText": "Lorem ipsum dolor sit amet...",
    "author_user_id": "e4d2e6b0-cde2-42c5-aac3-0b8316f21e58"
  }
}
```

### Тестовый клиент

Для тестирования WebSocket функциональности можно использовать встроенный тестовый клиент:

```bash
# Сначала получите JWT токен через REST API /login
# Затем запустите тестовый клиент
go run cmd/websocket_client/main.go ws://localhost:8080 your_jwt_token_here
```

## Безопасность

1. **Авторизация**: Все WebSocket соединения требуют валидный JWT токен
2. **Валидация токенов**: Используется тот же механизм валидации, что и для REST API
3. **Origin проверка**: В продакшене должна быть настроена проверка origin

## Мониторинг

WebSocket сервер интегрирован с существующей системой метрик Prometheus. Можно добавить дополнительные метрики:

- Количество активных WebSocket соединений
- Количество отправленных сообщений
- Время отклика WebSocket операций

## Конфигурация

WebSocket сервер использует те же настройки, что и основной HTTP сервер. Порт и адрес настраиваются через переменные окружения или конфигурационные файлы.

## Ограничения

1. **Масштабируемость**: Текущая реализация использует in-memory хаб. Для горизонтального масштабирования потребуется внешний брокер сообщений (Redis, RabbitMQ, Kafka)
2. **Персистентность**: Сообщения не сохраняются, клиенты получают только новые посты после подключения
3. **Доставка**: Нет гарантии доставки сообщений (at-most-once delivery)

## Планы развития

1. Интеграция с внешним брокером сообщений для горизонтального масштабирования
2. Добавление поддержки персональных уведомлений (только для друзей автора поста)
3. Реализация механизма подтверждения доставки сообщений
4. Добавление поддержки других типов уведомлений (лайки, комментарии)
